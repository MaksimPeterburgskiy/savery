{
  // See https://code.visualstudio.com/docs/editor/tasks for format docs
  "version": "2.0.0",
  "tasks": [
    {
      "label": "start dragonfly",
      "type": "shell",
      "command": "bash",
      "args": [
        "-lc",
        "if docker ps -a --format '{{.Names}}' | grep -q '^savery-dragonfly$'; then docker start savery-dragonfly >/dev/null || true; else docker run -d --name savery-dragonfly -p 6379:6379 --ulimit memlock=-1 docker.dragonflydb.io/dragonflydb/dragonfly >/dev/null; fi"
      ],
      "problemMatcher": [],

      "presentation": {
        "group": "Docker"
      },
      "windows": {
        "command": "powershell",
        "args": [
          "-NoProfile",
          "-NonInteractive",
          "-Command",
          "docker container inspect 'savery-dragonfly' > $null 2>&1; if ($LASTEXITCODE -eq 0) { docker start 'savery-dragonfly' | Out-Null } else { docker run -d --name 'savery-dragonfly' -p 6379:6379 --ulimit memlock=-1 docker.dragonflydb.io/dragonflydb/dragonfly | Out-Null }"
        ]
      }
    },
    {
      "label": "start postgres",
      "type": "shell",
      "command": "bash",
      "args": [
        "-lc",
        "IMAGE=savery/postgres-postgis-pgvector:local; CONTAINER=savery-postgres; if ! docker image inspect $IMAGE >/dev/null 2>&1; then docker build -t $IMAGE -f infra/docker/postgres-pgvector.Dockerfile infra/docker >/dev/null; fi; if docker ps -a --format '{{.Names}}' | grep -q \"^${CONTAINER}$\"; then docker start $CONTAINER >/dev/null || true; else docker run -d --name $CONTAINER -p 5432:5432 -e POSTGRES_DB=savery -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=postgres $IMAGE >/dev/null; fi"
      ],
      "problemMatcher": [],
      "presentation": {
        "group": "Docker"
      },
      "windows": {
        "command": "powershell",
        "args": [
          "-NoProfile",
          "-NonInteractive",
          "-Command",
          "if (-not (docker image inspect 'savery/postgres-postgis-pgvector:local' > $null 2>&1)) { docker build -t 'savery/postgres-postgis-pgvector:local' -f infra/docker/postgres-pgvector.Dockerfile infra/docker | Out-Null } docker container inspect 'savery-postgres' > $null 2>&1; if ($LASTEXITCODE -eq 0) { docker start 'savery-postgres' | Out-Null } else { docker run -d --name 'savery-postgres' -p 5432:5432 -e POSTGRES_DB=savery -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=postgres 'savery/postgres-postgis-pgvector:local' | Out-Null }"
        ]
      }
    },
    {
      "label": "start rabbitmq",
      "type": "shell",
      "command": "bash",
      "args": [
        "-lc",
        "if docker ps -a --format '{{.Names}}' | grep -q '^savery-rabbit$'; then docker start savery-rabbit >/dev/null || true; else docker run -d --name savery-rabbit -p 5672:5672 -p 15672:15672 rabbitmq:3-management >/dev/null; fi"
      ],
      "problemMatcher": [],
      "presentation": {
        "group": "Docker"
      },
      "windows": {
        "command": "powershell",
        "args": [
          "-NoProfile",
          "-NonInteractive",
          "-Command",
          "docker container inspect 'savery-rabbit' > $null 2>&1; if ($LASTEXITCODE -eq 0) { docker start 'savery-rabbit' | Out-Null } else { docker run -d --name 'savery-rabbit' -p 5672:5672 -p 15672:15672 rabbitmq:3-management | Out-Null }"
        ]
      }
    },
    {
      "label": "start services (postgres+rabbitmq+dragonfly)",
      "dependsOn": [
        "start postgres",
        "start rabbitmq",
        "start dragonfly"
      ],
      "problemMatcher": [],
      "presentation": {
        "group": "Docker"
      }
    },
    {
      "label": "stop services (postgres+rabbitmq+dragonfly)",
      "type": "shell",
      "command": "bash",
      "args": [
        "-lc",
        "docker stop savery-postgres savery-rabbit savery-dragonfly >/dev/null 2>&1 || true"
      ],
      "problemMatcher": [],
      "presentation": {
        "group": "Docker"
      },
      "windows": {
        "command": "powershell",
        "args": [
          "-NoProfile",
          "-NonInteractive",
          "-Command",
          "docker stop savery-postgres savery-rabbit savery-dragonfly 2>$null | Out-Null; if ($LASTEXITCODE -ne 0) { $global:LASTEXITCODE = 0 }"
        ]
      }
    }
  ]
}
